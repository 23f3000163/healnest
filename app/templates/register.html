{% extends "layout.html" %}
{% set minimal_footer = True %}
{% block content %}

<div class="page-container" style="max-width: 520px; margin-top: 70px; margin-bottom: 60px;">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h1 style="font-family:'Playfair Display', serif;">
            HealNest
        </h1>
        <p class="page-subtitle">
            Create your account to manage appointments seamlessly.
        </p>
    </div>

    <!-- CARD -->
    <div class="app-card auth-fade">

        <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <!-- EMAIL -->
            <div class="mb-3">
                {{ form.email.label(class="form-label fw-semibold") }}
                {{ form.email(class="form-control",
                              id="emailField",
                              placeholder="name@example.com",
                              autocomplete="email") }}
                <small id="emailFeedback" class="text-danger d-none">
                    Please enter a valid email.
                </small>
            </div>

            <!-- PASSWORD -->
            <div class="mb-3">
                {{ form.password.label(class="form-label fw-semibold") }}

                <div class="input-group">
                    {{ form.password(class="form-control",
                                     id="passwordField",
                                     placeholder="Create a strong password",
                                     autocomplete="new-password") }}
                    <button type="button"
                            class="btn btn-outline-secondary"
                            id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <!-- Strength Bar -->
                <div class="mt-3" style="height:6px; background:#e5e7eb; border-radius:999px;">
                    <div id="strengthBar"
                         style="height:6px; width:0%; border-radius:999px; transition:0.3s;">
                    </div>
                </div>

                <small class="text-muted">
                    Use 8+ characters with uppercase, numbers and symbols.
                </small>
            </div>

            <!-- CONFIRM PASSWORD -->
            <div class="mb-4">
                {{ form.confirm_password.label(class="form-label fw-semibold") }}
                {{ form.confirm_password(class="form-control",
                                         id="confirmField",
                                         placeholder="Re-enter password",
                                         autocomplete="new-password") }}
                <small id="confirmFeedback" class="text-danger d-none">
                    Passwords do not match.
                </small>
            </div>

            <!-- SUBMIT -->
            <button id="submitBtn"
                    class="btn-app btn-app-primary w-100"
                    disabled>
                Create Account
            </button>

            <!-- TRUST SIGNALS -->
            <div class="text-center mt-3">
                <small class="text-muted d-block">
                    üîí Your data is encrypted and secure.
                </small>
                <small class="text-muted d-block">
                    üè• Trusted by doctors & patients.
                </small>
            </div>

        </form>

        <hr>

        <div class="text-center">
            <small class="text-muted">
                Already have an account?
                <a href="{{ url_for('main.login') }}"
                   class="fw-semibold text-decoration-none">
                    Login
                </a>
            </small>
        </div>

    </div>

</div>

{% endblock %}

{% block scripts %}
<script>

// PASSWORD TOGGLE
const togglePassword = document.getElementById("togglePassword");
const passwordField = document.getElementById("passwordField");

togglePassword.addEventListener("click", () => {
    const type = passwordField.type === "password" ? "text" : "password";
    passwordField.type = type;
    togglePassword.innerHTML =
        type === "password"
            ? '<i class="fas fa-eye"></i>'
            : '<i class="fas fa-eye-slash"></i>';
});

// PASSWORD STRENGTH
const strengthBar = document.getElementById("strengthBar");

passwordField.addEventListener("input", () => {
    const password = passwordField.value;
    let score = 0;

    if (password.length >= 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;

    const widthMap = ["25%", "50%", "75%", "100%"];
    const colorMap = ["#dc3545", "#f59e0b", "#3b82f6", "#16a34a"];

    strengthBar.style.width = widthMap[score - 1] || "0%";
    strengthBar.style.background = colorMap[score - 1] || "#e5e7eb";

    validateForm();
});

// CONFIRM PASSWORD
const confirmField = document.getElementById("confirmField");
const confirmFeedback = document.getElementById("confirmFeedback");

function validateConfirm() {
    if (!confirmField.value) return;

    if (confirmField.value === passwordField.value) {
        confirmField.classList.remove("is-invalid");
        confirmField.classList.add("is-valid");
        confirmFeedback.classList.add("d-none");
    } else {
        confirmField.classList.remove("is-valid");
        confirmField.classList.add("is-invalid");
        confirmFeedback.classList.remove("d-none");
    }

    validateForm();
}

passwordField.addEventListener("input", validateConfirm);
confirmField.addEventListener("input", validateConfirm);

// EMAIL VALIDATION
const emailField = document.getElementById("emailField");
const emailFeedback = document.getElementById("emailFeedback");

emailField.addEventListener("blur", () => {
    const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value);

    if (!valid) {
        emailField.classList.add("is-invalid");
        emailFeedback.classList.remove("d-none");
    } else {
        emailField.classList.remove("is-invalid");
        emailFeedback.classList.add("d-none");
    }

    validateForm();
});

// ENABLE BUTTON
const submitBtn = document.getElementById("submitBtn");

function validateForm() {
    const strongEnough =
        strengthBar.style.width === "75%" ||
        strengthBar.style.width === "100%";

    const emailValid = !emailField.classList.contains("is-invalid");
    const confirmValid = confirmField.classList.contains("is-valid");

    submitBtn.disabled = !(strongEnough && emailValid && confirmValid);
}

</script>
{% endblock %}
