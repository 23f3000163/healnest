{% extends "layout.html" %}
{% set minimal_footer = True %}
{% block content %}

<div class="page-container" style="max-width: 520px; margin-top: 70px; margin-bottom: 60px;">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h1 style="font-family:'Playfair Display', serif;">
            HealNest
        </h1>
        <p class="page-subtitle">
            Create your account.
        </p>
    </div>

    <!-- CARD -->
    <div class="app-card auth-fade">

        <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <!-- EMAIL -->
            <div class="mb-3">
                {{ form.email.label(class="form-label fw-semibold") }}
                {{ form.email(class="form-control",
                id="emailField",
                placeholder="name@example.com",
                autocomplete="email") }}
                <small id="emailFeedback" class="text-danger d-none">
                    Please enter a valid email.
                </small>
            </div>

            <!-- PASSWORD -->
            <div class="mb-3">
                {{ form.password.label(class="form-label fw-semibold") }}

                <div class="input-group">
                    {{ form.password(class="form-control",
                    id="passwordField",
                    type="password",
                    placeholder="Create a strong password",
                    autocomplete="new-password") }}

                    <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <!-- Strength Bar -->
                <div class="mt-3" style="height:6px; background:#e5e7eb; border-radius:999px;">
                    <div id="strengthBar" style="height:6px; width:0%; border-radius:999px; transition:0.3s;">
                    </div>
                </div>

                <small class="text-muted">
                    Use 8+ characters with uppercase, numbers and symbols.
                </small>
            </div>

            <!-- CONFIRM PASSWORD -->
            <div class="mb-4">
                {{ form.confirm_password.label(class="form-label fw-semibold") }}
                {{ form.confirm_password(class="form-control",
                id="confirmField",
                placeholder="Re-enter password",
                autocomplete="new-password") }}
                <small id="confirmFeedback" class="text-danger d-none">
                    Passwords do not match.
                </small>
            </div>

            <!-- SUBMIT -->
            <button id="submitBtn" class="btn-app btn-app-primary w-100" disabled>
                Create Account
            </button>

            <!-- TRUST SIGNALS -->
            <div class="text-center mt-3">
                <small class="text-muted d-block">
                    üîí Your data is encrypted and secure.
                </small>
                <small class="text-muted d-block">
                    üè• Trusted by doctors & patients.
                </small>
            </div>

        </form>

        <hr>

        <div class="text-center">
            <small class="text-muted">
                Already have an account?
                <a href="{{ url_for('main.login') }}" class="fw-semibold text-decoration-none">
                    Login
                </a>
            </small>
        </div>

    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const passwordField = document.querySelector("#passwordField");
        const toggleBtn = document.querySelector("#togglePassword");
        const strengthBar = document.querySelector("#strengthBar");
        const confirmField = document.querySelector("#confirmField");
        const submitBtn = document.querySelector("#submitBtn");
        const emailField = document.querySelector("#emailField");

        if (!passwordField) {
            console.log("Password field not found");
            return;
        }

        /* ==========================
           PASSWORD TOGGLE (100% FIXED)
        ========================== */
        if (toggleBtn) {
            toggleBtn.addEventListener("click", function (e) {
                e.preventDefault();

                if (passwordField.type === "password") {
                    passwordField.type = "text";
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    passwordField.type = "password";
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        }

        /* ==========================
           PASSWORD STRENGTH (RELIABLE)
        ========================== */
        passwordField.addEventListener("input", function () {

            const password = passwordField.value;
            let score = 0;

            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            const percent = score * 25;

            strengthBar.style.width = percent + "%";

            if (percent <= 25) {
                strengthBar.style.background = "#dc3545";
            } else if (percent === 50) {
                strengthBar.style.background = "#f59e0b";
            } else if (percent === 75) {
                strengthBar.style.background = "#3b82f6";
            } else if (percent === 100) {
                strengthBar.style.background = "#16a34a";
            } else {
                strengthBar.style.background = "#e5e7eb";
            }

            validateForm();
        });

        /* ==========================
           CONFIRM MATCH
        ========================== */
        confirmField.addEventListener("input", validateForm);
        emailField.addEventListener("input", validateForm);

        function validateForm() {

            const strongEnough = passwordField.value.length >= 8;
            const passwordsMatch = passwordField.value === confirmField.value;
            const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value);

            submitBtn.disabled = !(strongEnough && passwordsMatch && emailValid);
        }

    });

    console.log("Script loaded");

</script>
{% endblock %}