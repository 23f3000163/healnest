{% extends "layout.html" %}
{% block content %}

<div class="dashboard-container">

    <!-- ================= UPCOMING APPOINTMENTS ================= -->
    <div class="app-card mb-4">
        <div class="app-card-header">
            Upcoming Appointments
        </div>

        {% if upcoming_appointments %}
        <div class="table-wrapper appointment-table" id="appointments-container">

            <div class="table-header">
                <div>Patient</div>
                <div>Date</div>
                <div>Time</div>
                <div>Status</div>
                <div class="text-end">Actions</div>
            </div>

            {% for appt in upcoming_appointments %}
            {% set is_today = appt.appointment_datetime.date() == today %}

            <div class="table-row {% if is_today %}today-highlight{% endif %}">

                <!-- Patient -->
                <div class="row-user">
                    <div class="avatar">
                        {{ appt.patient.patient_profile.full_name[:1]|upper }}
                    </div>
                    <div class="row-user-info">
                        <strong>
                            {{ appt.patient.patient_profile.full_name }}
                        </strong>
                    </div>
                </div>

                <!-- Date -->
                <div class="row-date">
                    {{ appt.appointment_datetime.strftime('%d %b %Y') }}
                    {% if is_today %}
                        <span class="today-badge">Today</span>
                    {% endif %}
                </div>

                <!-- Time -->
                <div class="row-time">
                    {{ appt.appointment_datetime.strftime('%I:%M %p') }}
                </div>

                <!-- Status -->
                <div>
                    <span class="status-pill status-pending">
                        Booked
                    </span>
                </div>

                <!-- Actions -->
                <div class="row-actions">

                    <a href="{{ url_for('doctor.view_patient_history', patient_id=appt.patient_id) }}"
                       class="action-btn action-edit">
                        <i class="fas fa-history"></i> History
                    </a>

                    <form action="{{ url_for('doctor.treat_patient', appointment_id=appt.id) }}" method="POST">
                        <button class="action-btn action-activate">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    </form>

                    <form action="{{ url_for('doctor.cancel_appointment', appointment_id=appt.id) }}"
                          method="POST"
                          onsubmit="return confirm('Cancel this appointment?');">
                        <button class="action-btn action-delete">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </form>

                </div>
            </div>

            {% endfor %}
        </div>

        <!-- Infinite scroll trigger -->
        {% if pagination.has_next %}
        <div id="load-trigger"
             data-next-page="{{ pagination.next_num }}"
             style="height:40px;">
        </div>
        {% endif %}

        {% else %}
        <div class="card-empty">
            No upcoming appointments.
        </div>
        {% endif %}
    </div>


    <!-- ================= ASSIGNED PATIENTS ================= -->
    <div class="app-card">
        <div class="app-card-header">
            Assigned Patients
        </div>

        {% if patients %}
        <div class="table-wrapper patient-table">

            <div class="table-header">
                <div>Patient</div>
                <div>Email</div>
                <div class="text-end">Actions</div>
            </div>

            {% for patient in patients %}
            <div class="table-row">

                <div class="row-user">
                    <div class="avatar">
                        {{ patient.patient_profile.full_name[:1]|upper }}
                    </div>
                    <div class="row-user-info">
                        <strong>
                            {{ patient.patient_profile.full_name }}
                        </strong>
                    </div>
                </div>

                <div class="col-email">
                    {{ patient.email }}
                </div>

                <div class="row-actions">
                    <a href="{{ url_for('doctor.view_patient_history', patient_id=patient.id) }}"
                       class="action-btn action-edit">
                        <i class="fas fa-user"></i> View History
                    </a>
                </div>

            </div>
            {% endfor %}

        </div>
        {% else %}
        <div class="card-empty">
            You have no assigned patients yet.
        </div>
        {% endif %}
    </div>

</div>


<!-- ================= INFINITE SCROLL ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const trigger = document.getElementById("load-trigger");
    if (!trigger) return;

    const observer = new IntersectionObserver((entries) => {

        if (entries[0].isIntersecting) {

            const nextPage = trigger.dataset.nextPage;

            fetch(`?page=${nextPage}`)
                .then(res => res.text())
                .then(html => {

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");

                    const newRows = doc.querySelectorAll("#appointments-container .table-row");
                    const container = document.getElementById("appointments-container");

                    newRows.forEach(row => container.appendChild(row));

                    const newTrigger = doc.getElementById("load-trigger");

                    if (newTrigger) {
                        trigger.dataset.nextPage = newTrigger.dataset.nextPage;
                    } else {
                        observer.disconnect();
                        trigger.remove();
                    }
                });
        }

    }, { threshold: 1.0 });

    observer.observe(trigger);
});
</script>

{% endblock %}
