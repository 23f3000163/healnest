{% extends "layout.html" %}
{% block content %}

<div class="dashboard-container app-page">

    <!-- ================= DASHBOARD HEADER ================= -->
    <div class="page-header">

        <div>
            <h1>Doctor Dashboard</h1>
            <p class="page-subtitle">
                Welcome back, Dr. {{ current_user.doctor_profile.full_name }}
            </p>
        </div>

        <div class="page-actions">

            <div class="status-pill status-active">
                <i class="fas fa-user-md me-1"></i>
                Active
            </div>

            <div class="status-pill" style="background:#eef2ff;color:#4f46e5;">
                <i class="fas fa-calendar-check me-1"></i>
                {{ upcoming_appointments|length }} Upcoming
            </div>

        </div>

    </div>
    <!-- ================= UPCOMING APPOINTMENTS ================= -->
    <div class="app-card table-card mb-4">

        <div class="app-card-header">
            Upcoming Appointments
        </div>

        {% if upcoming_appointments %}
        <div class="table-wrapper appointment-table" id="appointments-container">

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for appt in upcoming_appointments %}
                    {% set is_today = appt.appointment_datetime.date() == today %}

                    <tr class="{% if is_today %}today-highlight{% endif %}">

                        <!-- Patient -->
                        <td>
                            <div class="row-user">
                                <div class="avatar">
                                    {{ appt.patient.patient_profile.full_name[:1]|upper }}
                                </div>
                                <div>
                                    <strong>
                                        {{ appt.patient.patient_profile.full_name }}
                                    </strong>
                                </div>
                            </div>
                        </td>

                        <!-- Date -->
                        <td>
                            {{ appt.appointment_datetime.strftime('%d %b %Y') }}
                            {% if is_today %}
                            <span class="today-badge ms-2">Today</span>
                            {% endif %}
                        </td>

                        <!-- Time -->
                        <td>
                            {{ appt.appointment_datetime.strftime('%I:%M %p') }}
                        </td>

                        <!-- Status -->
                        <td>
                            <span class="status-pill status-pending">
                                Booked
                            </span>
                        </td>

                        <!-- Actions -->
                        <td class="text-end">
                            <div class="row-actions justify-content-end">

                                <a href="{{ url_for('doctor.view_patient_history', patient_id=appt.patient_id) }}"
                                    class="action-btn action-edit">
                                    <i class="fas fa-history"></i> History
                                </a>

                                <form action="{{ url_for('doctor.treat_patient', appointment_id=appt.id) }}"
                                    method="POST" class="d-inline">
                                    <button type="submit" class="action-btn action-activate">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </form>

                                <form action="{{ url_for('doctor.cancel_appointment', appointment_id=appt.id) }}"
                                    method="POST" class="d-inline"
                                    onsubmit="return confirm('Cancel this appointment?');">
                                    <button type="submit" class="action-btn action-delete">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </form>

                            </div>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>

        {% if pagination.has_next %}
        <div id="load-trigger" data-next-page="{{ pagination.next_num }}" style="height:40px;">
        </div>
        {% endif %}

        {% else %}
        <div class="card-empty">
            No upcoming appointments.
        </div>
        {% endif %}
    </div>


    <!-- ================= ASSIGNED PATIENTS ================= -->
    <div class="app-card table-card">

        <div class="app-card-header">
            Assigned Patients
        </div>

        {% if patients %}
        <div class="table-wrapper patient-table">

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Email</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for patient in patients %}
                    <tr>

                        <td>
                            <div class="row-user">
                                <div class="avatar">
                                    {{ patient.patient_profile.full_name[:1]|upper }}
                                </div>
                                <div>
                                    <strong>
                                        {{ patient.patient_profile.full_name }}
                                    </strong>
                                </div>
                            </div>
                        </td>

                        <td>
                            {{ patient.email }}
                        </td>

                        <td class="text-end">
                            <div class="row-actions justify-content-end">
                                <a href="{{ url_for('doctor.view_patient_history', patient_id=patient.id) }}"
                                    class="action-btn action-edit">
                                    <i class="fas fa-user"></i> View History
                                </a>
                            </div>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>

        {% else %}
        <div class="card-empty">
            You have no assigned patients yet.
        </div>
        {% endif %}
    </div>


    <!-- ================= INFINITE SCROLL ================= -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const trigger = document.getElementById("load-trigger");
            if (!trigger) return;

            const observer = new IntersectionObserver((entries) => {

                if (entries[0].isIntersecting) {

                    const nextPage = trigger.dataset.nextPage;

                    fetch(`?page=${nextPage}`)
                        .then(res => res.text())
                        .then(html => {

                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, "text/html");

                            const newRows = doc.querySelectorAll("#appointments-container .table-row");
                            const container = document.getElementById("appointments-container");

                            newRows.forEach(row => container.appendChild(row));

                            const newTrigger = doc.getElementById("load-trigger");

                            if (newTrigger) {
                                trigger.dataset.nextPage = newTrigger.dataset.nextPage;
                            } else {
                                observer.disconnect();
                                trigger.remove();
                            }
                        });
                }

            }, { threshold: 1.0 });

            observer.observe(trigger);
        });
    </script>

    {% endblock %}