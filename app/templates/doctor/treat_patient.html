{% extends "layout.html" %}
{% block content %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Treating: {{ appointment.patient.patient_profile.full_name }}</h4>
        </div>
        <div class="card-body">
            <p><strong>Appointment Date:</strong> {{ appointment.appointment_datetime.strftime('%d %b %Y, %I:%M %p') }}</p>
            <p><strong>Patient Email:</strong> {{ appointment.patient.email }}</p>
        </div>
    </div>

    <!-- Patient Medical History Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">Patient's Medical History</h5>
        </div>
        <div class="card-body">
            {% if patient_history %}
                {% for past_appt in patient_history %}
                    <div class="mb-3 p-3 bg-light rounded border">
                        <p class="mb-1"><strong>Date:</strong> {{ past_appt.appointment_datetime.strftime('%d %b %Y') }}</p>
                        <p class="mb-1"><strong>Doctor:</strong> Dr. {{ past_appt.doctor.doctor_profile.full_name }}</p>
                        <hr class="my-2">
                        <p class="mb-1"><strong>Diagnosis:</strong> {{ past_appt.treatment.diagnosis }}</p>
                        <p class="mb-0"><strong>Prescription:</strong> {{ past_appt.treatment.prescription }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No past medical history found for this patient.</p>
            {% endif %}
        </div>
    </div>

    <!-- New Treatment Form Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0">Add New Treatment Details</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.diagnosis.label(class="form-label") }}
                    {{ form.diagnosis(class="form-control") }}
                </div>
                <div class="mb-3">
                    {{ form.prescription.label(class="form-label") }}
                    {{ form.prescription(class="form-control") }}
                </div>
                <div class="form-group">
                    {{ form.submit(class="btn btn-success") }}
                    <a href="{{ url_for('doctor.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </form>
        </div>
    </div>
{% endblock content %}
```
---
## ## Part 3: The Backend Route (The Brains) ðŸ§ 

Now, we write the Python logic that powers this page. This route will fetch the patient's history, display the page, process the form submission, and update the database.

### **Step 1: Open the Doctor Routes File**
Navigate to and open your doctor routes file: **`app/routes/doctor_routes.py`**.

### **Step 2: Update the Imports**
Add the new `TreatmentForm` and `Treatment` model to your imports at the top.

```python
from app.forms import TreatmentForm # Add this import
from app.models import Appointment, Treatment # Add Treatment to this import
from app import db # Add this import
