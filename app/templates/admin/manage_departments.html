{% extends "layout.html" %}
{% block content %}

<div class="page-container app-page">

    <!-- ================= PAGE HEADER ================= -->
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>Manage Departments</h1>
            <p class="page-subtitle">Create, update and manage hospital departments</p>
        </div>

        <button class="btn-app btn-app-primary" data-bs-toggle="modal" data-bs-target="#addDeptModal">
            <i class="fas fa-plus"></i> Create Department
        </button>
    </div>

    <!-- ================= TABLE CARD ================= -->
    <div class="app-card table-card">

        <div class="table-responsive">

            <table class="table table-hover align-middle data-table">

                <thead>
                    <tr>
                        <th style="width:25%;">Name</th>
                        <th style="width:35%;">Description</th>
                        <th style="width:15%;">Doctors</th>
                        <th style="width:25%;" class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for department in departments.items %}
                    <tr>

                        <!-- NAME -->
                        <td class="fw-semibold">
                            {{ department.name }}
                        </td>

                        <!-- DESCRIPTION -->
                        <td class="text-muted">
                            {{ department.description[:80] ~ '…'
                            if department.description else '—' }}
                        </td>

                        <!-- DOCTOR COUNT -->
                        <td>
                            {% set doctor_count = department.doctors | length %}
                            <span class="dept-pill">
                                {{ doctor_count }} {{ "Doctor" if doctor_count == 1 else "Doctors" }}
                            </span>

                        </td>

                        <!-- ACTIONS -->
                        <td class="text-end">
                            <div class="row-actions">

                                <!-- VIEW -->
                                <a href="{{ url_for('admin.department_details', dept_id=department.id) }}"
                                    class="action-btn action-activate">
                                    <i class="fas fa-eye"></i> View
                                </a>

                                <!-- EDIT -->
                                <button class="action-btn action-edit" data-bs-toggle="modal"
                                    data-bs-target="#editDeptModal" data-id="{{ department.id }}"
                                    data-name="{{ department.name }}" data-description="{{ department.description }}">
                                    <i class="fas fa-pen"></i> Edit
                                </button>

                                <!-- DELETE -->
                                <form action="{{ url_for('admin.delete_department', dept_id=department.id) }}"
                                    method="POST" class="d-inline"
                                    onsubmit="return confirm('Are you sure? This cannot be undone.');">
                                    <button type="submit" class="action-btn action-delete">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>

                            </div>
                        </td>

                    </tr>

                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-4 text-muted">
                            No departments found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>

        <!-- ================= PAGINATION ================= -->
        {% if departments.pages > 1 %}
        <div class="pagination-wrapper">

            {% if departments.has_prev %}
            <a href="{{ url_for('admin.manage_departments',
                        page=departments.prev_num) }}" class="btn-app btn-app-outline btn-sm">
                Previous
            </a>
            {% else %}
            <span></span>
            {% endif %}

            <div class="pagination-info">
                Page {{ departments.page }} of {{ departments.pages }}
            </div>

            {% if departments.has_next %}
            <a href="{{ url_for('admin.manage_departments',
                        page=departments.next_num) }}" class="btn-app btn-app-outline btn-sm">
                Next
            </a>
            {% else %}
            <span></span>
            {% endif %}

        </div>
        {% endif %}

    </div>

</div>


<!-- ================= ADD DEPARTMENT MODAL ================= -->
<div class="modal fade" id="addDeptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content app-modal">

            <form method="POST" action="{{ url_for('admin.manage_departments') }}">

                {{ form.hidden_tag() }}

                <div class="modal-header">
                    <h5 class="modal-title">Create Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control", required=True) }}
                    </div>

                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="3") }}
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app-outline" data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <button type="submit" class="btn-app btn-app-primary">
                        Create
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- ================= EDIT DEPARTMENT MODAL ================= -->
<div class="modal fade" id="editDeptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content app-modal">

            <form method="POST" action="{{ url_for('admin.edit_department') }}">

                <input type="hidden" name="dept_id" id="editDeptId">

                <div class="modal-header">
                    <h5 class="modal-title">Edit Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label">Department Name</label>
                        <input type="text" name="name" id="editDeptName" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" id="editDeptDesc" class="form-control" rows="3"></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-app btn-app-outline" data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <button type="submit" class="btn-app btn-app-primary">
                        Save Changes
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- ================= EDIT MODAL SCRIPT ================= -->
<script>
    document.getElementById('editDeptModal')
        .addEventListener('show.bs.modal', function (event) {

            const button = event.relatedTarget;

            document.getElementById('editDeptId').value =
                button.getAttribute('data-id');

            document.getElementById('editDeptName').value =
                button.getAttribute('data-name');

            document.getElementById('editDeptDesc').value =
                button.getAttribute('data-description') || '';
        });
</script>

{% endblock %}