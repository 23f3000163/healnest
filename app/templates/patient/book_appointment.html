{% extends "layout.html" %}
{% block content %}

<h3 class="mb-3">
    Book Appointment with Dr. {{ doctor.full_name }}
</h3>

<form method="POST">
    {{ form.hidden_tag() }}

    <!-- Date picker -->
    <div class="mb-3">
        <label class="form-label fw-bold">Select Date</label>
        <input
            type="date"
            id="appointment-date"
            class="form-control"
            min="{{ min_date }}"
            max="{{ max_date }}"
            required
        >
    </div>

    <!-- Slots container -->
    <div class="mb-3">
        <label class="form-label fw-bold">Available Slots</label>

        <div
            id="slots-container"
            class="d-flex flex-wrap gap-2 border rounded p-3 bg-light"
        >
            <span class="text-muted">
                Select a date to view available slots
            </span>
        </div>

        <p
            id="no-slots-msg"
            class="text-danger mt-2"
            style="display: none;"
        >
            No slots available for the selected date.
        </p>
    </div>

    <!-- Hidden field that backend reads -->
    <input type="hidden" name="selected_slot" id="selected-slot">

    <button
        type="submit"
        class="btn btn-success"
        disabled
        id="book-btn"
    >
        Confirm Booking
    </button>

    <a href="{{ url_for('patient.dashboard') }}" class="btn btn-outline-secondary ms-2">
        Cancel
    </a>
</form>

<script>
const dateInput = document.getElementById("appointment-date");
const slotsContainer = document.getElementById("slots-container");
const selectedSlotInput = document.getElementById("selected-slot");
const bookBtn = document.getElementById("book-btn");
const noSlotsMsg = document.getElementById("no-slots-msg");

dateInput.addEventListener("change", async () => {
    const date = dateInput.value;

    // Reset UI
    slotsContainer.innerHTML = "<span class='text-muted'>Loading slots...</span>";
    selectedSlotInput.value = "";
    bookBtn.disabled = true;
    noSlotsMsg.style.display = "none";

    const res = await fetch(
        `/patient/doctor/{{ doctor.id }}/slots?date=${date}`
    );

    const data = await res.json();
    slotsContainer.innerHTML = "";

    if (data.slots.length === 0) {
        noSlotsMsg.style.display = "block";
        slotsContainer.innerHTML =
            "<span class='text-muted'>No slots available</span>";
        return;
    }

    data.slots.forEach(slot => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-primary";
        btn.textContent = slot.label;

        btn.addEventListener("click", () => {
            document
                .querySelectorAll("#slots-container button")
                .forEach(b => {
                    b.classList.remove("btn-primary");
                    b.classList.add("btn-outline-primary");
                });

            btn.classList.remove("btn-outline-primary");
            btn.classList.add("btn-primary");

            selectedSlotInput.value = slot.value;
            bookBtn.disabled = false;
        });

        slotsContainer.appendChild(btn);
    });
});
</script>

{% endblock %}
