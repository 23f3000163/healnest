{% extends "layout.html" %}
{% block content %}

<div class="page-container">

    <!-- ================= HEADER ================= -->
    <div class="page-header">
        <div>
            <h1>Book Appointment</h1>

            <p class="page-subtitle">
                <span class="fw-bold text-dark">
                    Dr. {{ doctor.full_name }}
                </span>
                &nbsp;&nbsp;â€¢&nbsp;&nbsp;
                <span class="dept-pill">
                    {{ doctor.department.name if doctor.department }}
                </span>
            </p>
        </div>

        <a href="{{ url_for('patient.dashboard') }}"
           class="btn-app btn-app-outline">
            Back to Dashboard
        </a>
    </div>


    <!-- ================= BOOKING CARD ================= -->
    <div class="app-card">

        <form method="POST" id="booking-form">
            {{ form.hidden_tag() if form }}

            <!-- ================= DATE SELECTION ================= -->
            <div class="mb-4">
                <label class="form-label fw-semibold mb-3">
                    Select Date (Next 7 Days)
                </label>

                <div id="date-container"
                     class="d-flex flex-wrap gap-3">
                </div>
            </div>


            <!-- ================= SLOTS ================= -->
            <div class="mb-4">
                <label class="form-label fw-semibold">
                    Available Slots
                </label>

                <div id="slots-container"
                     class="border rounded p-4"
                     style="background:#f9fafb;">
                    <span class="text-muted">
                        Select a date to view available slots
                    </span>
                </div>
            </div>


            <!-- ================= SUMMARY ================= -->
            <div id="summary-panel"
                 class="app-card mt-4"
                 style="display:none; border:1px solid #e5e7eb;">

                <div class="app-card-header">
                    Appointment Summary
                </div>

                <div style="padding:20px;">
                    <p><strong>Doctor:</strong> Dr. {{ doctor.full_name }}</p>
                    <p><strong>Date:</strong> <span id="summary-date"></span></p>
                    <p><strong>Time:</strong> <span id="summary-time"></span></p>
                </div>
            </div>

            <input type="hidden" name="selected_slot" id="selected-slot">
            <input type="hidden" name="selected_date" id="selected-date">

            <!-- SUBMIT -->
            <div class="mt-4 text-end">
                <button type="button"
                        id="confirm-btn"
                        class="btn-app btn-app-primary"
                        disabled>
                    Confirm Booking
                </button>
            </div>

        </form>
    </div>
</div>


<!-- ================= STYLES ================= -->
<style>

.date-card {
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    text-align: center;
    width: 95px;
    background: white;
    transition: all 0.2s ease;
}

.date-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}

.date-card.active {
    background: #c46638;
    color: white;
    border-color: #c46638;
}

.date-card.today {
    border: 2px solid #c46638;
}

.slot-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    font-weight: 600;
    font-size: 0.85rem;
    transition: 0.2s ease;
}

.slot-btn:hover {
    transform: translateY(-2px);
}

.slot-btn.active {
    background: #c46638;
    color: white;
    border-color: #c46638;
}

.slot-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

</style>


<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const dateContainer = document.getElementById("date-container");
    const slotsContainer = document.getElementById("slots-container");
    const selectedDateInput = document.getElementById("selected-date");
    const selectedSlotInput = document.getElementById("selected-slot");
    const confirmBtn = document.getElementById("confirm-btn");
    const summaryPanel = document.getElementById("summary-panel");

    const summaryDate = document.getElementById("summary-date");
    const summaryTime = document.getElementById("summary-time");

    const today = new Date();
    const minDate = new Date("{{ min_date }}");
    const maxDate = new Date("{{ max_date }}");

    // Generate next 7 days
    for (let i = 0; i < 7; i++) {

        const date = new Date();
        date.setDate(today.getDate() + i);

        if (date < minDate || date > maxDate) continue;

        const card = document.createElement("div");
        card.className = "date-card";

        if (date.toDateString() === today.toDateString()) {
            card.classList.add("today");
        }

        card.innerHTML = `
            <div style="font-size:12px;">
                ${date.toLocaleDateString("en-US",{ weekday:"short" })}
            </div>
            <div style="font-size:18px;font-weight:700;">
                ${date.getDate()}
            </div>
            <div style="font-size:12px;">
                ${date.toLocaleDateString("en-US",{ month:"short" })}
            </div>
        `;

        card.addEventListener("click", async () => {

            document.querySelectorAll(".date-card")
                .forEach(d => d.classList.remove("active"));

            card.classList.add("active");

            selectedDateInput.value =
                date.toISOString().split("T")[0];

            summaryDate.textContent =
                date.toDateString();

            summaryPanel.style.display = "none";
            confirmBtn.disabled = true;

            loadSlots(date);
        });

        dateContainer.appendChild(card);
    }


    async function loadSlots(dateObj) {

        slotsContainer.innerHTML = "Loading...";

        try {

            const response = await fetch(
                `/patient/doctor/{{ doctor.id }}/slots?date=${
                    dateObj.toISOString().split("T")[0]
                }`
            );

            const data = await response.json();
            slotsContainer.innerHTML = "";

            if (!data.slots || data.slots.length === 0) {
                slotsContainer.innerHTML =
                    "<span class='text-muted'>No slots available</span>";
                return;
            }

            data.slots.forEach(slot => {

                const btn = document.createElement("button");
                btn.type = "button";
                btn.textContent = slot.label;
                btn.className = "slot-btn me-2 mb-2";

                if (slot.booked) {
                    btn.classList.add("disabled");
                    btn.disabled = true;
                }

                btn.addEventListener("click", () => {

                    document.querySelectorAll(".slot-btn")
                        .forEach(b => b.classList.remove("active"));

                    btn.classList.add("active");

                    selectedSlotInput.value = slot.value;
                    summaryTime.textContent = slot.label;

                    summaryPanel.style.display = "block";
                    confirmBtn.disabled = false;
                });

                slotsContainer.appendChild(btn);
            });

        } catch {
            slotsContainer.innerHTML =
                "<span class='text-danger'>Error loading slots</span>";
        }
    }


    confirmBtn.addEventListener("click", function () {
        document.getElementById("booking-form").submit();
    });

});
</script>

{% endblock %}
