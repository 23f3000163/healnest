{% extends "layout.html" %}
{% block content %}

<div class="dashboard-container">

    <!-- ================= HEADER ================= -->
    <div class="dashboard-header d-flex justify-content-between align-items-center">

        <div>
            <h1>Patient Dashboard</h1>
            <p>Manage your appointments and find doctors by department</p>
        </div>

        <a href="{{ url_for('patient.my_history') }}" class="btn-app btn-app-primary">
            <i class="fas fa-file-medical"></i>
            View Full History
        </a>

    </div>


    <!-- ================= FIND DOCTOR BY DEPARTMENT ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Find a Doctor by Department
        </div>

        {% if departments %}
        <div class="table-wrapper">

            <div class="table-header" style="display:grid; grid-template-columns: 2fr 1fr;">
                <div>Department</div>
                <div class="text-end">Action</div>
            </div>

            {% for dept in departments %}

            {% set dept_name = dept.name.lower() %}

            {% if "cardio" in dept_name %}
            {% set icon = "fa-heartbeat" %}
            {% set color_class = "dept-cardiology" %}
            {% elif "neuro" in dept_name %}
            {% set icon = "fa-brain" %}
            {% set color_class = "dept-neurology" %}
            {% elif "ortho" in dept_name %}
            {% set icon = "fa-bone" %}
            {% set color_class = "dept-orthopedics" %}
            {% elif "pedia" in dept_name %}
            {% set icon = "fa-baby" %}
            {% set color_class = "dept-pediatrics" %}
            {% else %}
            {% set icon = "fa-stethoscope" %}
            {% set color_class = "" %}
            {% endif %}

            <div class="table-row" style="display:grid; grid-template-columns: 2fr 1fr; align-items:center;">

                <!-- DEPARTMENT -->
                <div class="row-user">
                    <div class="avatar {{ color_class }}">
                        <i class="fas {{ icon }}"></i>
                    </div>

                    <div class="row-user-info">
                        <strong>{{ dept.name }}</strong>
                        <span class="col-email">
                            {{ dept.description or 'Explore doctors in this department' }}
                        </span>
                    </div>
                </div>

                <!-- ACTION -->
                <div class="row-actions">
                    <a href="{{ url_for('patient.department_details', department_id=dept.id) }}"
                        class="action-btn action-edit">
                        <i class="fas fa-eye"></i> View Doctors
                    </a>
                </div>

            </div>

            {% endfor %}


        </div>

        {% else %}
        <div class="card-empty">
            No departments available.
        </div>
        {% endif %}

    </div>


    <!-- ================= UPCOMING APPOINTMENTS ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Upcoming Appointments
        </div>

        {% if upcoming_appointments %}
        <div class="table-wrapper appointment-table">

            <div class="table-header">
                <div>Doctor</div>
                <div>Date</div>
                <div>Time</div>
                <div>Status</div>
                <div class="text-end">Actions</div>
            </div>

            {% for appt in upcoming_appointments %}
            {% set is_today = appt.appointment_datetime.date() == today %}



            <div class="table-row {% if is_today %}today-highlight{% endif %}">

                <!-- DOCTOR -->
                <div class="row-user">
                    <div class="avatar">
                        {{ appt.doctor.doctor_profile.full_name[:1]|upper }}
                    </div>
                    <div class="row-user-info">
                        <strong>
                            Dr. {{ appt.doctor.doctor_profile.full_name }}
                        </strong>
                        <span class="col-email">
                            {{ appt.doctor.email }}
                        </span>
                    </div>
                </div>

                <!-- DATE -->
                <div class="row-date">
                    {{ appt.appointment_datetime.strftime('%d %b %Y') }}
                    {% if is_today %}
                    <span class="today-badge">Today</span>
                    {% endif %}
                </div>

                <!-- TIME -->
                <div class="row-time">
                    {{ appt.appointment_datetime.strftime('%I:%M %p') }}
                </div>

                <!-- STATUS -->
                <div>
                    {% if appt.status == "BOOKED" %}
                    <span class="status-pill status-pending">Booked</span>
                    {% elif appt.status == "CONFIRMED" %}
                    <span class="status-pill status-active">Confirmed</span>
                    {% elif appt.status == "CANCELLED" %}
                    <span class="status-pill status-cancelled">Cancelled</span>
                    {% else %}
                    <span class="status-pill">{{ appt.status }}</span>
                    {% endif %}
                </div>

                <!-- ACTION -->
                <div class="row-actions">
                    {% if appt.status != "CANCELLED" %}
                    <form action="{{ url_for('patient.cancel_appointment', appointment_id=appt.id) }}" method="POST"
                        onsubmit="return confirm('Cancel this appointment?');">
                        <button class="action-btn action-delete">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </form>
                    {% else %}
                    <span class="text-muted">â€”</span>
                    {% endif %}
                </div>

            </div>
            {% endfor %}

        </div>

        {% else %}
        <div class="card-empty">
            No upcoming appointments.
        </div>
        {% endif %}

    </div>


    <!-- ================= PAST APPOINTMENTS ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Past Appointments
        </div>

        {% if past_appointments %}
        <div class="table-wrapper appointment-table">

            <div class="table-header">
                <div>Doctor</div>
                <div>Date</div>
                <div>Time</div>
                <div>Status</div>
                <div></div>
            </div>

            {% for appt in past_appointments %}

            <div class="table-row">

                <div class="row-user">
                    <div class="avatar">
                        {{ appt.doctor.doctor_profile.full_name[:1]|upper }}
                    </div>
                    <div class="row-user-info">
                        <strong>
                            Dr. {{ appt.doctor.doctor_profile.full_name }}
                        </strong>
                    </div>
                </div>

                <div class="row-date">
                    {{ appt.appointment_datetime.strftime('%d %b %Y') }}
                </div>

                <div class="row-time">
                    {{ appt.appointment_datetime.strftime('%I:%M %p') }}
                </div>

                <div>
                    {% if appt.status == "COMPLETED" %}
                    <span class="status-pill status-completed">Completed</span>
                    {% elif appt.status == "CANCELLED" %}
                    <span class="status-pill status-cancelled">Cancelled</span>
                    {% elif appt.status == "BOOKED" %}
                    <span class="status-pill status-pending">Missed</span>
                    {% else %}
                    <span class="status-pill">{{ appt.status }}</span>
                    {% endif %}
                </div>

                <div></div>

            </div>

            {% endfor %}
        </div>

        {% else %}
        <div class="card-empty">
            No past appointments.
        </div>
        {% endif %}

    </div>

</div>

{% endblock %}