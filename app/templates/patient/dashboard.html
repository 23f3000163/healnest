{% extends "layout.html" %}
{% block content %}

<div class="dashboard-container app-page">

    <!-- ================= HEADER ================= -->
    <div class="page-header">

        <div>
            <h1>Patient Dashboard</h1>
            <p class="page-subtitle">
                Welcome,
                {% if current_user.patient_profile and current_user.patient_profile.full_name %}
                {{ current_user.patient_profile.full_name }}
                {% else %}
                {{ current_user.email }}
                {% endif %}
            </p>
        </div>

        <div class="page-actions">
            <a href="{{ url_for('patient.my_history') }}" class="btn-app btn-app-primary">
                <i class="fas fa-file-medical"></i>
                View Full History
            </a>
        </div>

    </div>


    <!-- ================= FIND DOCTOR BY DEPARTMENT ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Find a Doctor by Department
        </div>

        {% if departments %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Department</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>

                <tbody>
                    {% for dept in departments %}

                    {% set dept_name = dept.name.lower() %}

                    {% if "cardio" in dept_name %}
                    {% set icon = "fa-heartbeat" %}
                    {% set color_class = "dept-cardiology" %}
                    {% elif "neuro" in dept_name %}
                    {% set icon = "fa-brain" %}
                    {% set color_class = "dept-neurology" %}
                    {% elif "ortho" in dept_name %}
                    {% set icon = "fa-bone" %}
                    {% set color_class = "dept-orthopedics" %}
                    {% elif "pedia" in dept_name %}
                    {% set icon = "fa-baby" %}
                    {% set color_class = "dept-pediatrics" %}
                    {% else %}
                    {% set icon = "fa-stethoscope" %}
                    {% set color_class = "" %}
                    {% endif %}

                    <tr>
                        <td>
                            <div class="row-user">
                                <div class="avatar-circle {{ color_class }}">
                                    <i class="fas {{ icon }}"></i>
                                </div>
                                <div>
                                    <strong>{{ dept.name }}</strong>
                                    <div class="text-muted">
                                        {{ dept.description or 'Explore doctors in this department' }}
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="text-end">
                            <a href="{{ url_for('patient.department_details', department_id=dept.id) }}"
                                class="action-btn action-edit">
                                <i class="fas fa-eye"></i> View Doctors
                            </a>
                        </td>
                    </tr>

                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card-empty">
            No departments available.
        </div>
        {% endif %}

    </div>


    <!-- ================= UPCOMING APPOINTMENTS ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Upcoming Appointments
        </div>

        {% if upcoming_appointments %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for appt in upcoming_appointments %}
                    {% set is_today = appt.appointment_datetime.date() == today %}

                    <tr class="{% if is_today %}today-highlight{% endif %}">

                        <td>
                            <div class="row-user">
                                <div class="avatar">
                                    {{ appt.doctor.doctor_profile.full_name[:1]|upper }}
                                </div>
                                <div>
                                    <strong>Dr. {{ appt.doctor.doctor_profile.full_name }}</strong>
                                    <div class="text-muted">
                                        {{ appt.doctor.email }}
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td>
                            {{ appt.appointment_datetime.strftime('%d %b %Y') }}
                            {% if is_today %}
                            <span class="today-badge">Today</span>
                            {% endif %}
                        </td>

                        <td>
                            {{ appt.appointment_datetime.strftime('%I:%M %p') }}
                        </td>

                        <td>
                            {% if appt.status == "BOOKED" %}
                            <span class="status-pill status-pending">Booked</span>
                            {% elif appt.status == "CONFIRMED" %}
                            <span class="status-pill status-active">Confirmed</span>
                            {% elif appt.status == "CANCELLED" %}
                            <span class="status-pill status-cancelled">Cancelled</span>
                            {% else %}
                            <span class="status-pill">{{ appt.status }}</span>
                            {% endif %}
                        </td>

                        <td class="text-end">
                            {% if appt.status != "CANCELLED" %}
                            <form action="{{ url_for('patient.cancel_appointment', appointment_id=appt.id) }}"
                                method="POST" onsubmit="return confirm('Cancel this appointment?');" class="d-inline">
                                <button class="action-btn action-delete">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted">â€”</span>
                            {% endif %}
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card-empty">
            No upcoming appointments.
        </div>
        {% endif %}

    </div>


    <!-- ================= PAST APPOINTMENTS ================= -->
    <div class="app-card">

        <div class="app-card-header">
            Past Appointments
        </div>

        {% if past_appointments %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>

                <tbody>
                    {% for appt in past_appointments %}

                    <tr>

                        <td>
                            <div class="row-user">
                                <div class="avatar">
                                    {{ appt.doctor.doctor_profile.full_name[:1]|upper }}
                                </div>
                                <div>
                                    <strong>Dr. {{ appt.doctor.doctor_profile.full_name }}</strong>
                                </div>
                            </div>
                        </td>

                        <td>{{ appt.appointment_datetime.strftime('%d %b %Y') }}</td>
                        <td>{{ appt.appointment_datetime.strftime('%I:%M %p') }}</td>

                        <td>
                            {% if appt.status == "COMPLETED" %}
                            <span class="status-pill status-completed">Completed</span>
                            {% elif appt.status == "CANCELLED" %}
                            <span class="status-pill status-cancelled">Cancelled</span>
                            {% elif appt.status == "BOOKED" %}
                            <span class="status-pill status-pending">Missed</span>
                            {% else %}
                            <span class="status-pill">{{ appt.status }}</span>
                            {% endif %}
                        </td>

                        <td></td>

                    </tr>

                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="card-empty">
            No past appointments.
        </div>
        {% endif %}

    </div>

</div>

{% endblock %}